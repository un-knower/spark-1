package com.wzq.spark.ml.feature.transformers

import com.wzq.spark.utils.Accounts_toDestiny
import org.apache.spark.ml.Pipeline
import org.apache.spark.ml.feature.{PCA, StandardScaler, StringIndexer, VectorAssembler}

/**
  * 标准化的pca
  */
object Pca {
  def main(args: Array[String]): Unit = {
    val file="data/accounts.log"
    val filter="金币消费结算统计"
    val r ="""^(\S+) Bill\[\d+\]  INFO: \[金币消费结算统计\]时间\((\d+)\)类别\((\d+)\)名称\((.*?)\)频道\((\d+)\)等级\((\d+)\)用户\((\d+)\)赠送\((\d+)\)个道具\((\d+)\)给歌手\((\d+)\),歌手等级\((\d+)\),签约\((\d+)\), 消耗金币\((\d+)\), 歌手获得金币\((\d+)\), 频道获得金币\((\d+)\),歌手当前金币\((\d+)\)频道当前金币\((\d+)\)用户当前金币\((\d+)\)""".r
    val rawDataset=Accounts_toDestiny.fileDataset(file,filter,r)
    val indexer1=new StringIndexer().setInputCol("date").setOutputCol("date_idx")
    val indexer2=new StringIndexer().setInputCol("name").setOutputCol("name_idx")
    val features=new VectorAssembler()
      .setInputCols(Array(indexer1.getOutputCol, "time", "category", indexer2.getOutputCol, "channel", "userLevel", "userId", "give", "tools", "singerId", "singerLevel", "contract", "consumeGold", "singer_gainGold", "channel_gainGold", "singer_currGold", "channel_currGold", "user_currGold"))
      .setOutputCol("features")
    val scaled=new StandardScaler().setInputCol(features.getOutputCol).setOutputCol("scaledFeatures")
     .setWithMean(true)
    val pca=new PCA().setInputCol(scaled.getOutputCol).setOutputCol("pcaFeatures").setK(4)
    val pipeline=new Pipeline().setStages(Array(indexer1,indexer2,features,scaled,pca))
    val model=pipeline.fit(rawDataset)
    model.transform(rawDataset).show(false)

    /**
      降维： 18 ——>> 4
    +---------------+----------+--------+------+-------+---------+--------+----+-----+--------+-----------+--------+-----------+---------------+----------------+---------------+----------------+-------------+--------+--------+---------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------+
|date           |time      |category|name  |channel|userLevel|userId  |give|tools|singerId|singerLevel|contract|consumeGold|singer_gainGold|channel_gainGold|singer_currGold|channel_currGold|user_currGold|date_idx|name_idx|features                                                                                                                                           |scaledFeatures                                                                                                                                                                                                                                                                                         |pcaFeatures                                                                        |
+---------------+----------+--------+------+-------+---------+--------+----+-----+--------+-----------+--------+-----------+---------------+----------------+---------------+----------------+-------------+--------+--------+---------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------+
|170806-01:25:55|1501953955|4       |金币赠送礼物|3644079|8        |84643006|520 |129  |25862610|60         |1       |1040000    |416000         |104000          |94896320       |547191360       |227717200    |2.0     |0.0     |[2.0,1.501953955E9,4.0,0.0,3644079.0,8.0,8.4643006E7,520.0,129.0,2.586261E7,60.0,1.0,1040000.0,416000.0,104000.0,9.489632E7,5.4719136E8,2.277172E8]|[0.3872983346207417,-0.5732881472539499,0.0,0.0,-0.1214599904761927,1.4836507379417576,0.5,1.4822504888725785,1.390758974918296,-1.491619146358595,1.0521896705559053,0.5,0.45533075635333753,1.1988162402927587,1.1988162402927587,1.3927278046737146,1.4487478598507357,0.5000175662919818]          |[3.2942023873338715,2.678869349201056,0.007370260498340921,-2.862293735361732E-17] |
|170806-01:56:15|1501955775|4       |金币赠送礼物|3144000|1        |32317467|82  |9    |92891067|1          |0       |1640000    |262400         |65600           |262400         |193530          |7025         |3.0     |0.0     |[3.0,1.501955775E9,4.0,0.0,3144000.0,1.0,3.2317467E7,82.0,9.0,9.2891067E7,1.0,0.0,1640000.0,262400.0,65600.0,262400.0,193530.0,7025.0]             |[1.161895003862225,1.4979464492764496,0.0,0.0,-1.3690830015597355,-0.7027819284987273,-1.5,-0.27716879060218946,-0.9933992677987828,0.6464930480909094,-1.358652681397431,-1.5,1.1957059699360002,0.45040876789409284,0.45040876789409284,-0.9894382366125885,-0.8494366982810615,-1.4999999998457116] |[-4.064403776580569,1.74816791428883,0.014134285452922918,2.255140518769849E-16]   |
|170806-01:27:32|1501954052|4       |金币赠送礼物|3991487|2        |84643006|1   |49   |85871004|38         |1       |2000       |720            |180             |31557920       |131048500       |227715200    |0.0     |0.0     |[0.0,1.501954052E9,4.0,0.0,3991487.0,2.0,8.4643006E7,1.0,49.0,8.5871004E7,38.0,1.0,2000.0,720.0,180.0,3.155792E7,1.310485E8,2.277152E8]            |[-1.161895003862225,-0.4628981715048022,0.0,0.0,0.745271496017964,-0.3904344047215152,0.5,-0.6025408491351945,-0.19867985355975656,0.4225630491338429,0.1532315054207629,0.5,-0.8255183631446689,-0.8246125040934257,-0.8246125040934257,-0.20165384610655931,-0.2996559589154235,0.49999999994857053] |[0.4424772496499025,-2.340943563940596,0.3504556194242277,-7.45931094670027E-17]   |
|170806-01:27:33|1501954053|4       |金币赠送礼物|3991487|2        |84643006|1   |49   |85871004|38         |1       |2000       |720            |180             |31558640       |131048680       |227713200    |1.0     |0.0     |[1.0,1.501954053E9,4.0,0.0,3991487.0,2.0,8.4643006E7,1.0,49.0,8.5871004E7,38.0,1.0,2000.0,720.0,180.0,3.155864E7,1.3104868E8,2.277132E8]           |[-0.3872983346207417,-0.4617601305176976,0.0,0.0,0.745271496017964,-0.3904344047215152,0.5,-0.6025408491351945,-0.19867985355975656,0.4225630491338429,0.1532315054207629,0.5,-0.8255183631446689,-0.8246125040934257,-0.8246125040934257,-0.2016357219545668,-0.29965520265425066,0.49998243360515937]|[0.32772413959679497,-2.0860936995492896,-0.3719601653754916,8.847089727481716E-17]|
+---
      */
  }
}
